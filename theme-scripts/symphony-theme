#!/bin/bash

SCRIPT_DIR="$HOME/dotfiles/theme-scripts"

show_ascii_art() {
  cat <<'ASCII'
 ╔══════════════════════════════════════════════════════════════════════════╗
 ║                                                                          ║
 ║ ║███████╗██╗   ██╗███╗   ███╗██████╗ ██╗  ██╗ ██████╗ ███╗   ██╗██╗   ██╗║
 ║ ██╔════╝╚██╗ ██╔╝████╗ ████║██╔══██╗██║  ██║██╔═══██╗████╗  ██║╚██╗ ██╔╝ ║
 ║ ███████╗ ╚████╔╝ ██╔████╔██║██████╔╝███████║██║   ██║██╔██╗ ██║ ╚████╔╝  ║
 ║ ╚════██║  ╚██╔╝  ██║╚██╔╝██║██╔═══╝ ██╔══██║██║   ██║██║╚██╗██║  ╚██╔╝   ║
 ║ ███████║   ██║   ██║ ╚═╝ ██║██║     ██║  ██║╚██████╔╝██║ ╚████║   ██║    ║
 ║ ╚══════╝   ╚═╝   ╚═╝     ╚═╝╚═╝     ╚═╝  ╚═╝ ╚═════╝ ╚═╝  ╚═══╝   ╚═╝    ║
 ║                                                                          ║ 
 ╚══════════════════════════════════════════════════════════════════════════╝
ASCII
}

show_help() {
  show_ascii_art
  cat <<'HELP'

Usage: symphony-theme <command> [options]

THEME MANAGEMENT
  switch [theme]         Switch themes (opens menu if no theme given)
  list                   Show installed themes
  remove <name>          Remove a theme
  fix                    Fix broken symlinks & reload apps

CONFIG GENERATION
  generate               Interactive config generator
  generate --theme zen   Generate for specific theme
  generate --all         Generate for all themes
  generate --force       Force regenerate existing files

UTILITIES
  install                Run installer
  uninstall              Remove themes/system
  lock-matugen           Lock matugen mode on wallpaper scripts

INFO
  help                   Show this help
  version                Show version

EXAMPLES
  symphony-theme switch
  symphony-theme switch zen
  symphony-theme fix
  symphony-theme generate
  symphony-theme generate --theme sakura --force

KEYBOARD SHORTCUTS (Hyprland)
  SUPER+CTRL+SHIFT+SPACE    Theme switcher
  SUPER+ALT+LEFT/RIGHT      Cycle wallpapers
  SUPER+CTRL+SPACE          Matugen picker
  SUPER+ALT+SPACE           Wallpaper picker

FILES STRUCTURE
  ~/dotfiles/themes/zen/.config/
    ├── kitty/colors.conf        [Main color source]
    ├── rofi/colors.rasi         [Generated from kitty]
    ├── starship.toml            [Generated from kitty]
    ├── hypr/theme/colors.conf   [Manual]
    ├── gtk-3.0/colors.css       [Manual]
    └── ...

WHAT DOES "FIX" DO?
  Recreates all symlinks for current theme. Use when:
  - Symlinks point to wrong files
  - Colors not updating after theme switch
  - Config files show as broken links
  - After moving theme directories

COLOR GENERATION
  Priority: kitty → btop → skip
  Extracts colors from kitty/colors.conf (16-color palette)
  Generates configs for rofi, starship, cava, rmpc, yazi

TROUBLESHOOTING
  Colors wrong:        symphony-theme fix
  Theme won't switch:  Check ~/.config/symphony/.current-theme
  Config missing:      symphony-theme generate --theme <name>

DOCUMENTATION
  README:  ~/dotfiles/theme-scripts/README.md
  Source:  https://github.com/vyrx-dev/dotfiles
  License: MIT

WARNING
  Read scripts before running. Not responsible for issues.
  Backup your dotfiles before major changes.
HELP
}

show_version() {
  show_ascii_art
  echo ""
  echo "  Version:  2.0"
  echo "  Author:   vyrx"
  echo "  Location: $SCRIPT_DIR"
  echo "  License:  MIT"
  echo "  Issues:   https://github.com/vyrx-dev/dotfiles/issues"
}

# Command routing
case "${1:-help}" in
switch)
  shift
  if [[ -n "$1" ]]; then
    SYMPHONY_DIRECT_SWITCH="$1" "$SCRIPT_DIR/core/switch-theme.sh"
  else
    "$SCRIPT_DIR/core/switch-theme.sh"
  fi
  ;;
list)
  echo "Installed themes:"
  find "$HOME/dotfiles/themes" -mindepth 1 -maxdepth 1 -type d -exec basename {} \; | sort
  ;;
remove)
  if [[ -z "$2" ]]; then
    echo "Usage: symphony-theme remove <theme-name>"
    exit 1
  fi
  THEME_DIR="$HOME/dotfiles/themes/$2"
  if [[ ! -d "$THEME_DIR" ]]; then
    echo "Theme not found: $2"
    exit 1
  fi
  echo "Remove theme: $2"
  echo "Location: $THEME_DIR"
  read -rp "Type 'yes' to confirm: " confirm
  if [[ "$confirm" == "yes" ]]; then
    rm -rf "$THEME_DIR"
    echo "[OK] Removed $2"
  else
    echo "Cancelled"
  fi
  ;;
fix)
  "$SCRIPT_DIR/core/fix-symlinks.sh"
  ;;
generate)
  shift
  "$SCRIPT_DIR/generate-configs" "$@"
  ;;
install)
  "$SCRIPT_DIR/install.sh"
  ;;
uninstall)
  "$SCRIPT_DIR/uninstall.sh"
  ;;
lock-matugen)
  "$SCRIPT_DIR/utils/lock-matugen-mode.sh"
  ;;
version | -v | --version)
  show_version
  ;;
help | --help | -h)
  show_help
  ;;
*)
  echo "Unknown command: $1"
  echo "Run 'symphony-theme help' for usage"
  exit 1
  ;;
esac
