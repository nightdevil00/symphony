#!/bin/bash

# Symphony - Config Generator
# Extracts colors from kitty/btop and generates app configs
# Usage: ./generate-configs [--theme NAME] [--all] [--force]
# https://github.com/vyrx-dev/dotfiles

set -e

THEMES_DIR="$HOME/dotfiles/themes"
FORCE=false
THEME_NAME=""
ALL_THEMES=false

# Parse args
while [[ $# -gt 0 ]]; do
  case $1 in
  --theme)
    THEME_NAME="$2"
    shift 2
    ;;
  --all)
    ALL_THEMES=true
    shift
    ;;
  --force)
    FORCE=true
    shift
    ;;
  --help)
    grep "^#" "$0" | sed 's/^# \?//'
    exit 0
    ;;
  *)
    echo "Unknown option: $1"
    exit 1
    ;;
  esac
done

# Color extraction from kitty
get_color_kitty() {
  local file=$1 key=$2
  grep "^${key}" "$file" 2>/dev/null | awk '{print $2}' | head -1
}

# Color extraction from btop
get_color_btop() {
  local file=$1 key=$2
  grep "^theme\[${key}\]=" "$file" 2>/dev/null | cut -d'"' -f2
}

# Find color source for theme
find_color_source() {
  local theme=$1

  if [[ -f "$THEMES_DIR/$theme/.config/kitty/colors.conf" ]]; then
    echo "kitty"
    return 0
  elif [[ -f "$THEMES_DIR/$theme/.config/btop/themes/current.theme" ]]; then
    echo "btop"
    return 0
  fi

  return 1
}

# Extract all colors from source
extract_colors() {
  local theme=$1
  local source=$2

  if [[ "$source" == "kitty" ]]; then
    local file="$THEMES_DIR/$theme/.config/kitty/colors.conf"
    BG=$(get_color_kitty "$file" "background")
    FG=$(get_color_kitty "$file" "foreground")
    C0=$(get_color_kitty "$file" "color0")
    C1=$(get_color_kitty "$file" "color1")
    C2=$(get_color_kitty "$file" "color2")
    C3=$(get_color_kitty "$file" "color3")
    C4=$(get_color_kitty "$file" "color4")
    C5=$(get_color_kitty "$file" "color5")
    C6=$(get_color_kitty "$file" "color6")
    C7=$(get_color_kitty "$file" "color7")
    C8=$(get_color_kitty "$file" "color8")
    C9=$(get_color_kitty "$file" "color9")
    C10=$(get_color_kitty "$file" "color10")
    C11=$(get_color_kitty "$file" "color11")
    C12=$(get_color_kitty "$file" "color12")
    C13=$(get_color_kitty "$file" "color13")
    C14=$(get_color_kitty "$file" "color14")
    C15=$(get_color_kitty "$file" "color15")
  elif [[ "$source" == "btop" ]]; then
    local file="$THEMES_DIR/$theme/.config/btop/themes/current.theme"
    BG=$(get_color_btop "$file" "main_bg")
    FG=$(get_color_btop "$file" "main_fg")
    C1=$(get_color_btop "$file" "title")
    C2=$(get_color_btop "$file" "hi_fg")
    C4=$(get_color_btop "$file" "selected_bg")
    C6=$(get_color_btop "$file" "selected_fg")
    C8=$(get_color_btop "$file" "inactive_fg")
    # Fill in missing with sensible defaults
    C0=${C0:-$BG}
    C3=${C3:-$C1}
    C5=${C5:-$C2}
    C7=${C7:-$FG}
  fi
}

# Generate starship.toml
generate_starship() {
  local theme=$1
  local output="$THEMES_DIR/$theme/.config/starship.toml"

  [[ -f "$output" && "$FORCE" != true ]] && return 0

  cat >"$output" <<EOF
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#  Generated with Symphony
#  Theme: $theme
#  https://github.com/vyrx-dev
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

add_newline = false
command_timeout = 60
format = """\
\$os \
\$directory \
\$git_branch\$git_status\
\$line_break\
\$character\
"""

palette = "colors"

[palettes.colors]
color1 = '$C6'
color6 = '$C8'
color8 = '$C6'
color9 = '$C5'
error = '$C1'

[directory]
style = "fg:color1 bold"
read_only = " ó°Œ¾"
read_only_style = "fg:error"
truncation_length = 0
truncate_to_repo = false
format = "[\$path](\$style)[\$read_only](\$read_only_style)"

[character]
success_symbol = '[â¯](fg:color8 bold)'
error_symbol = '[â¯](fg:error bold)'
vicmd_symbol = '[â®](fg:color6 bold)'

[git_branch]
style = "fg:color9 bold"
format = '[\$symbol\$branch](\$style) '

[git_status]
ahead = 'â‡¡\${count}'
behind = 'â‡£\${count}'
diverged = 'â‡•â‡¡\${ahead_count}â‡£\${behind_count}'
format = '[[(\$all_status\$ahead_behind )](fg:error)](\$style)'

[os]
format = "[\$symbol](\$style)"
style = "fg:color8 bold"
disabled = false

[os.symbols]
Linux = "ó°Š  "
Arch = "ó°£‡"

[line_break]
disabled = true
EOF

  echo "  [OK] starship.toml"
}

# Generate rofi colors
generate_rofi() {
  local theme=$1
  local output="$THEMES_DIR/$theme/.config/rofi/colors.rasi"

  [[ -f "$output" && "$FORCE" != true ]] && return 0

  mkdir -p "$(dirname "$output")"

  cat >"$output" <<EOF
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 *  Generated with Symphony
 *  Theme: $theme
 *  https://github.com/vyrx-dev
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

* {
    primary: ${C6};
    primary-container: ${C4};
    on-primary: ${C0};
    on-primary-container: ${C15:-$FG};
    
    secondary: ${C5};
    secondary-container: ${C8};
    on-secondary: ${C0};
    on-secondary-container: ${FG};
    
    surface: ${C0};
    surface-dim: ${C0};
    surface-bright: ${C8};
    surface-container-lowest: ${C0};
    surface-container-low: ${C0};
    surface-container: ${C8};
    surface-container-high: ${C8};
    surface-container-highest: ${C8};
    
    on-surface: ${C15:-$FG};
    on-surface-variant: ${C7};
    
    outline: ${C8};
    outline-variant: ${C8};
    
    error: ${C1};
    on-error: ${C0};
    
    inverse-surface: ${FG};
    inverse-on-surface: ${BG};
}
EOF

  echo "  [OK] rofi/colors.rasi"
}

# Generate cava config
generate_cava() {
  local theme=$1
  local output="$THEMES_DIR/$theme/.config/cava-config"

  [[ -f "$output" && "$FORCE" != true ]] && return 0

  local gradient=("$C8" "$C2" "$C10" "$C3" "$C11" "$C6" "$C14")

  cat >"$output" <<EOF
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#  Generated with Symphony
#  Theme: $theme
#  https://github.com/vyrx-dev
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[color]

background = '$BG'
gradient = 1
gradient_count = ${#gradient[@]}
gradient_color_1 = '${gradient[0]}'
gradient_color_2 = '${gradient[1]}'
gradient_color_3 = '${gradient[2]}'
gradient_color_4 = '${gradient[3]}'
gradient_color_5 = '${gradient[4]}'
gradient_color_6 = '${gradient[5]}'
gradient_color_7 = '${gradient[6]}'
EOF

  echo "  [OK] cava-config"
}

# Generate rmpc theme
generate_rmpc() {
  local theme=$1
  local output="$THEMES_DIR/$theme/.config/rmpc/themes/theme.ron"

  [[ -f "$output" && "$FORCE" != true ]] && return 0

  mkdir -p "$(dirname "$output")"

  cat >"$output" <<EOF
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Generated with Symphony
//  Theme: $theme
//  https://github.com/vyrx-dev
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

#![enable(implicit_some)]
#![enable(unwrap_newtypes)]
#![enable(unwrap_variant_newtypes)]
(
    default_album_art_path: None,
    show_song_table_header: false,
    draw_borders: true,
    browser_column_widths: [20, 38, 42],
    text_color: "$FG",
    tab_bar: (
        enabled: true,
        active_style: (fg: "$FG", bg: "$BG", modifiers: "Bold"),
        inactive_style: (fg: "$C8", modifiers: ""),
    ),
    highlighted_item_style: (fg: "$C4", modifiers: "Bold"),
    current_item_style: (fg: "$BG", bg: "$C4", modifiers: "Bold"),
    borders_style: (fg: "$C8", modifiers: ""),
    highlight_border_style: (fg: "$C4"),
    symbols: (song: "ó°š ", dir: " ", marker: "* ", ellipsis: "..."),
    progress_bar: (
        symbols: ["â–ˆ", "â–ˆ", "â–ˆ"],
        track_style: (fg: "$C8"),
        elapsed_style: (fg: "$C4"),
        thumb_style: (fg: "$C4"),
    ),
    scrollbar: (
        symbols: ["", "", "", ""],
        track_style: (fg: "$C8"),
        ends_style: (fg: "$C8"),
        thumb_style: (fg: "$C4"),
    ),
    song_table_format: [
        (
            prop: (kind: Property(Title), style: (fg: "$FG"),
                highlighted_item_style: (fg: "$BG", modifiers: "Bold"),
                default: (kind: Property(Filename), style: (fg: "$C8"),)
            ),
            width: "70%",
        ),
        (
            prop: (kind: Property(Album), style: (fg: "$C8"),
                default: (kind: Text("Unknown Album"), style: (fg: "$C8"))
            ),
            width: "30%",
        ),
    ],
    layout: Split(
        direction: Vertical,
        panes: [
            (
                size: "3",
                pane: Pane(Tabs),
            ),
            (
                size: "4",
                pane: Split(
                    direction: Horizontal,
                    panes: [
                        (
                            size: "100%",
                            pane: Split(
                                direction: Vertical,
                                panes: [
                                    (
                                        size: "4",
                                        borders: "ALL",
                                        pane: Pane(Header),
                                    ),
                                ]
                            )
                        ),
                    ]
                ),
            ),
            (
                size: "100%",
                pane: Split(
                    direction: Horizontal,
                    panes: [
                        (
                            size: "100%",
                            borders: "NONE",
                            pane: Pane(TabContent),
                        ),
                    ]
                ),
            ),
            (
                size: "3",
                borders: "TOP | BOTTOM",
                pane: Pane(ProgressBar),
            ),
        ],
    ),
    header: (
        rows: [
            (
                left: [
                    (kind: Property(Status(StateV2(playing_label: " ", paused_label: "âšâš", stopped_label: "âšâš"))), style: (fg: "$C4", modifiers: "Bold")),
                ],
                center: [
                    (kind: Property(Song(Title)), style: (fg: "$FG", modifiers: "Bold"),
                        default: (kind: Property(Song(Filename)), style: (fg: "$FG", modifiers: "Bold"))
                    )
                ],
                right: [
                    (kind: Text("Vol: "), style: (fg: "$C4", modifiers: "Bold")),
                    (kind: Property(Status(Volume)), style: (fg: "$C4", modifiers: "Bold")),
                    (kind: Text("% "), style: (fg: "$C4", modifiers: "Bold"))
                ]
            ),
            (
                left: [
                    (kind: Property(Status(Elapsed)), style: (fg: "$FG")),
                    (kind: Text("/"), style: (fg: "$C8")),
                    (kind: Property(Status(Duration)), style: (fg: "$FG")),
                ],
                center: [
                    (kind: Property(Song(Artist)), style: (fg: "$C3", modifiers: "Bold"),
                        default: (kind: Text("Unknown Artist"), style: (fg: "$C8", modifiers: ""))
                    ),
                ],
                right: [
                    (
                        kind: Property(Widget(States(
                            active_style: (fg: "$C4", modifiers: "Bold"),
                            separator_style: (fg: "$C8")))
                        ),
                        style: (fg: "$C8")
                    ),
                ]
            ),
        ],
    ),
    browser_song_format: [
        (
            kind: Group([
                (kind: Property(Track)),
                (kind: Text(" ")),
            ])
        ),
        (
            kind: Group([
                (kind: Property(Artist)),
                (kind: Text(" - ")),
                (kind: Property(Title)),
            ]),
            default: (kind: Property(Filename))
        ),
    ],
)
EOF

  echo "  [OK] rmpc/themes/theme.ron"
}

# Generate yazi theme
generate_yazi() {
  local theme=$1
  local colors_json="$THEMES_DIR/$theme/.cache/wal/colors.json"
  local output="$THEMES_DIR/$theme/.config/yazi/theme.toml"

  [[ -f "$output" && "$FORCE" != true ]] && return 0
  [[ ! -f "$colors_json" ]] && return 0

  mkdir -p "$(dirname "$output")"

  # Extract from pywal
  local c0=$(jq -r '.colors.color0' "$colors_json")
  local c1=$(jq -r '.colors.color1' "$colors_json")
  local c2=$(jq -r '.colors.color2' "$colors_json")
  local c3=$(jq -r '.colors.color3' "$colors_json")
  local c4=$(jq -r '.colors.color4' "$colors_json")
  local c5=$(jq -r '.colors.color5' "$colors_json")
  local c6=$(jq -r '.colors.color6' "$colors_json")
  local c7=$(jq -r '.colors.color7' "$colors_json")
  local c8=$(jq -r '.colors.color8' "$colors_json")

  cat >"$output" <<EOF
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#  Generated with Symphony
#  Theme: $theme
#  https://github.com/vyrx-dev
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[mgr]
cwd = { fg = "$c7" }
tab_active = { fg = "$c0", bg = "$c4", bold = true }
tab_inactive = { fg = "$c8", bg = "$c0" }
tab_width = 1
border_symbol = " "
border_style = { fg = "$c4" }

[status]
separator_open = "ðŸ­"
separator_close = "ðŸ­ "

[mode]
normal_main = { bg = "$c4", fg = "$c0", bold = true }
normal_alt = { bg = "$c8", fg = "$c7" }

[filetype]
rules = [
    { mime = "image/*", fg = "$c6" },
    { mime = "{audio,video}/*", fg = "$c5" },
    { name = "*/", fg = "$c4" },
]
EOF

  echo "  [OK] yazi/theme.toml"
}

# Process single theme
process_theme() {
  local theme=$1

  # Skip matugen (uses templates)
  [[ "$theme" == "matugen" ]] && return 0

  # Find color source
  local source
  source=$(find_color_source "$theme") || {
    echo "âš  $theme - no color source (need kitty or btop)"
    return 0
  }

  echo "$theme ($source):"

  # Extract colors
  extract_colors "$theme" "$source"

  # Generate configs
  generate_starship "$theme"
  generate_rofi "$theme"
  generate_cava "$theme"
  generate_rmpc "$theme"
  generate_yazi "$theme"

  echo ""
}

# Interactive selection with gum
interactive_mode() {
  command -v gum >/dev/null 2>&1 || {
    echo "Error: gum not installed (needed for interactive mode)"
    echo "Install: sudo pacman -S gum"
    exit 1
  }

  # Get theme list
  local themes=()
  for dir in "$THEMES_DIR"/*; do
    [[ -d "$dir" ]] && themes+=("$(basename "$dir")")
  done

  # Select theme
  echo "Select theme:"
  THEME_NAME=$(printf '%s\n' "${themes[@]}" | gum choose --header="Which theme?")

  [[ -z "$THEME_NAME" ]] && exit 0

  # Find what's missing
  local configs=(
    "starship.toml"
    "rofi/colors.rasi"
    "cava-config"
    "rmpc/themes/theme.ron"
    "yazi/theme.toml"
  )

  local missing=()
  for cfg in "${configs[@]}"; do
    [[ ! -f "$THEMES_DIR/$THEME_NAME/.config/$cfg" ]] && missing+=("$cfg")
  done

  if [[ ${#missing[@]} -eq 0 ]]; then
    echo ""
    echo "[OK] All configs exist for $THEME_NAME"
    echo ""
    gum confirm "Regenerate all?" && FORCE=true || exit 0
  else
    echo ""
    echo "Missing configs:"
    printf '  [ ] %s\n' "${missing[@]}"
    echo ""
    gum confirm "Generate missing configs?" || exit 0
  fi

  process_theme "$THEME_NAME"
}

# Main
main() {
  if [[ -n "$THEME_NAME" ]]; then
    # Single theme
    process_theme "$THEME_NAME"
  elif [[ "$ALL_THEMES" == true ]]; then
    # All themes
    for dir in "$THEMES_DIR"/*; do
      [[ -d "$dir" ]] && process_theme "$(basename "$dir")"
    done
  else
    # Interactive
    interactive_mode
  fi

  echo "[DONE] Configs generated"
}

main
