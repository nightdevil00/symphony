#!/bin/bash

# Check if custom theme is active
CURRENT_THEME=$(cat ~/.config/symphony/.current-theme 2>/dev/null || echo "matugen")
if [[ "$CURRENT_THEME" != "matugen" ]]; then
    notify-send "Theme Locked" "Using custom theme: $CURRENT_THEME\nUse switch-theme.sh to change themes"
    exit 0
fi


# Directory containing wallpapers
WALLPAPER_DIR="$HOME/Wallpapers/"
STATE_FILE="$HOME/.current_wallpaper_index"

mapfile -t WALLPAPERS < <(find "$WALLPAPER_DIR" -type f \( -iname '*.jpg' -o -iname '*.png' \) | sort)

# Get number of wallpapers
NUM_WALLPAPERS=${#WALLPAPERS[@]}
if [ "$NUM_WALLPAPERS" -eq 0 ]; then
  echo "No wallpapers found in $WALLPAPER_DIR"
  exit 1
fi

if [ -f "$STATE_FILE" ]; then
  INDEX=$(<"$STATE_FILE")
  INDEX=$((RANDOM % NUM_WALLPAPERS))
  # INDEX=$(((INDEX + 1) % NUM_WALLPAPERS)) #cycles through wallpapers in sequence
else
  INDEX=0
fi

echo "$INDEX" >"$STATE_FILE"

CURRENT_WALLPAPER="${WALLPAPERS[$INDEX]}"

# Start swww daemon if needed
swww query &>/dev/null || swww-daemon --format xrgb

swww img "$CURRENT_WALLPAPER" --transition-type=any --transition-fps 60 --transition-duration=1

# Update wallpaper symlink to track current wallpaper
DISPLAYED_WALLPAPER=$(swww query | grep "currently displaying" | head -1 | sed 's/.*image: //')
if [ -n "$DISPLAYED_WALLPAPER" ]; then
  ln -sf "$DISPLAYED_WALLPAPER" "$HOME/dotfiles/themes/matugen/wallpaper"
fi

# SWWW_PARAMS="--transition-fps 60 --transition-type=any --transition-duration=1"
matugen image "$CURRENT_WALLPAPER" -m dark
wal -i "$CURRENT_WALLPAPER"

# Update symphony apps that need special handling with matugen
"$HOME/dotfiles/theme-scripts/core/update-cava-colors.sh" matugen
"$HOME/dotfiles/theme-scripts/core/update-rmpc-theme.sh" matugen
"$HOME/dotfiles/theme-scripts/core/fix-symlinks.sh"

# Update Obsidian theme
bash "$HOME/dotfiles/theme-scripts/core/update-obsidian-theme.sh"

pywalfox update
hyprctl reload
restart-app waybar
restart-app swayosd-server
killall -SIGUSR1 kitty
pkill -SIGUSR1 alacritty
pkill -SIGUSR2 btop
ghostty +reload-config
killall -SIGUSR2 ghostty

pgrep -x nautilus >/dev/null && (
  pkill -x nautilus
  nautilus &>/dev/null &
  disown
)

if [[ -f ~/.config/alacritty/alacritty.toml ]]; then
  touch ~/.config/alacritty/alacritty.toml
fi

killall -SIGUSR1 swaync
notify-send -i "$CURRENT_WALLPAPER" "Theme changed" "Wallpaper has been updated."
