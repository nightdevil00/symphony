#!/bin/bash
# Wallpaper picker - swww only (no theme changes)

WALLPAPER_DIR="$HOME/Wallpapers/"
SWWW_PARAMS="--transition-fps 120 --transition-type=center --transition-pos=bottom --transition-duration=1 --transition-bezier=0.25,0.1,0.25,1.0"

# Get focused monitor
focused_monitor=$(hyprctl -j monitors | jq -r '.[] | select(.focused==true).name')
: "${focused_monitor:=HDMI-A-1}"

# Get wallpapers
mapfile -d '' wallpapers < <(find "$WALLPAPER_DIR" -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.gif" \) -print0)

[[ ${#wallpapers[@]} -eq 0 ]] && { notify-send "Error" "No wallpapers found in $WALLPAPER_DIR"; exit 1; }

# Build menu with thumbnails
menu() {
  for wallpaper in "${wallpapers[@]}"; do
    printf "%s\x00icon\x1f%s\n" "$(basename "$wallpaper")" "$wallpaper"
  done | sort
}

# Start swww if needed
swww query &>/dev/null || swww-daemon --format xrgb

# Show menu
choice=$(menu | rofi -i -dmenu -config ~/.config/rofi/custom-rofi/config-wallpaper.rasi)
[[ -z "$choice" ]] && exit 0

# Apply wallpaper
for wallpaper in "${wallpapers[@]}"; do
  [[ "$(basename "$wallpaper")" == "$choice" ]] || continue
  
  swww img -o "$focused_monitor" "$wallpaper" $SWWW_PARAMS
  
  # Track current wallpaper
  mkdir -p "$HOME/.config/symphony/current"
  CURRENT_WALLPAPER=$(swww query 2>/dev/null | grep "currently displaying" | head -1 | sed 's/.*image: //')
  [[ -n "$CURRENT_WALLPAPER" ]] && ln -sf "$CURRENT_WALLPAPER" "$HOME/.config/symphony/current/wallpaper"
  
  notify-send -i "$wallpaper" "Wallpaper Changed" "$(basename "$wallpaper")"
  break
done
